"undefined"==typeof Perch&&(Perch={},Perch.UI={},Perch.Apps={}),Perch.UI.Global=function(){var a,b,c="cmssb",d=!1,e=!1,f=3e5,g=function(){$("body").addClass("js"),document.all&&document.querySelector&&!document.addEventListener&&(a=!0),document.all&&!document.querySelector&&(b=!0),head.load({lang:Perch.path+"/core/inc/js_lang.php?v="+Perch.version},{privs:Perch.path+"/core/inc/js_privs.php?v="+Perch.version}),$.ajaxSetup({cache:!0,data:{v:Perch.version}}),t(),v(),r(),s($(".main")),h(),i(),j(),B(),C(),a||w(),a||x(),D(),A(),E()},h=function(){$("a.assist, a.draft-preview").click(function(a){a.preventDefault(),window.open($(this).attr("href"))})},i=function(){$("p.alert.success")&&setTimeout("$('p.alert.success').selfHealingRemove()",5e3)},j=function(){$(window).on("load",function(){o(),p()}),$(window).on("resize",function(){d=!0,setTimeout(function(){d&&(o(),d=!1)},1e3),p()}),q(),k(),l(),m(),$(window).on("Perch_Init_Editors_Post",function(){p(),m()})},k=function(){if(!a){var b=$("form.magnetic-save-bar");b.length&&document.addEventListener("keydown",function(a){83==a.keyCode&&(navigator.platform.match("Mac")?a.metaKey:a.ctrlKey)&&(a.preventDefault(),b.submit())},!1)}},l=function(){var a=$(".routes-spare"),b=$(".field.routes");a.length&&b.length&&(a.addClass("hidden"),a.parent().find(".routes:last").append('<a href="#" class="icon plusone add">'+Perch.Lang.get("Add another")+"</a>"),$(".routes").on("click",".plusone",function(b){b.preventDefault(),a.removeClass("hidden").find("input").focus(),$(this).selfHealingRemove()}))},m=function(){var a=$("[data-count]");a.on("keyup",function(){n(this)}),a.each(function(a,b){n(b)})},n=function(a){var b=$(a),c=$("#"+b.attr("data-count-container")),d=b.val();d&&c.html("words"==b.attr("data-count")?d.match(/\S+/g).length:d.length)},o=function(){if(!a){var b=$(".magnetic-save-bar p.submit");if(b.length&&!b.hasClass("nonstick")){var c=$(window),d=b.position().top,e=b.outerHeight(!0),f=c.height(),g=$("p.alert");g&&(d-=g.outerHeight(!0)),$("body").height()>f&&(c.scroll(function(){var a=c.scrollTop()+f-e-70;if(d>a){b.addClass("stuck"),b.parents("form").addClass("with-stuck");var g=a-d;if(50>-g)var h=.7/100*(-g/50)*100;else var h=.7;b.hasClass("error")?b.css("background-color","rgba(179, 64, 64, "+h+")"):b.css("background-color","rgba(191, 191, 191, "+h+")")}else b.removeClass("stuck"),b.parents("form").removeClass("with-stuck"),b.css("background-color","rgba(255, 255, 255, 1)")}),c.scroll())}}},p=function(){var a=$("textarea.autowidth, .editor-wrap");a.length&&a.each(function(a,b){var c=$(b),d=c.parents("div.field"),e=d.find("label:first");if(d&&e){var f=d.innerWidth()-e.outerWidth();f>200&&c.width(f-41)}})},q=function(){$(".divider").prev("div.field").addClass("predivider")},r=function(){$("body");$.getScript(Perch.path+"/core/assets/js/headroom.min.js",function(){var a=new Headroom($(".topbar").get(0),{offset:60,tolerance:0});a.init()})},s=function(a){if(a)var b=a.find(".smartbar:not(.ready)");else var b=$(".smartbar:not(.ready)");if(b.length){var c=b.find(".filter");c.on("click","li a",function(a){var b=$(this).parent("li"),c=b.parents("ul");(!c.hasClass("open")||b.is(":first-child"))&&a.preventDefault(),c.hasClass("open")?(c.removeClass("open"),c.parent("li").find(".proxy").remove()):(c.parent("li").append($('<p class="proxy">.</p>')),c.addClass("open"))}),c.each(function(a,b){var c=$(b);c.css("width",c.find("li:first-child").outerWidth())}),b.addClass("ready")}},t=function(){var a=$("body");1==$.cookie(c)&&a.addClass("sidebar-closed").removeClass("sidebar-open"),head.ready(["lang"],function(){$(".topbar").append($('<a href="#" id="sidebar-toggle" class="icon"><span>'+Perch.Lang.get("Toggle sidebar")+"</span></a>"));var a=$("#sidebar-toggle");a.on("click",function(a){a.preventDefault(),u()})})},u=function(a){var b=$("body");b.toggleClass("sidebar-closed").toggleClass("sidebar-open"),b.hasClass("sidebar-closed")?$.cookie(c,1,{path:"/"}):$.cookie(c,0,{path:"/"}),p(),$(window).trigger("perch.sidebar-toggle"),a&&a()},v=function(){var a=$("#appmenu ul.appmenu"),c=a.find("li");if(c.length>1&&!b){a.addClass("menu");var d=$("#appmenu");d.addClass("menucont");var e=a.find("li.selected a:not(.add)").text();if(e)var f=!0;else{e=Perch.Lang.get("Apps");var f=!1}var g=$('<a class="trigger" href="#">'+e+"</a>");a.before(g).hide(),f&&g.parent("li").addClass("selected"),a.prepend($('<li class="dumb"><a class="trigger" href="#">'+e+'</a></li><li class="spaceinvader"></li>')),d.hover(function(){a.show()},function(){a.hide()}),g.click(function(b){b.preventDefault(),a.show()}),a.find("a.trigger").click(function(b){b.preventDefault(),a.hide()})}$(".topbar .mainnav").show()},w=function(){$("a.inline-delete").click(function(a){a.preventDefault();var b=$(this),c=Perch.Lang.get("Delete this item?");b.attr("data-msg")&&(c=b.attr("data-msg")),y(a,c,function(){$.post(b.attr("href"),{_perch_ajax:1,formaction:"delete",token:Perch.token},function(a){window.location=a})},function(){z()},"delete")})},x=function(){$("a.inline-confirm").click(function(a){a.preventDefault();var b=$(this),c=Perch.Lang.get("Are you sure?");b.attr("data-msg")&&(c=b.attr("data-msg")),y(a,c,function(){$.post(b.attr("href"),{_perch_ajax:1,formaction:"confirm",token:Perch.token},function(a){window.location=a})},function(){z()},"confirm")})},y=function(a,b,c,d,f){e&&z();var g=$(a.target);e=$('<div id="confirm-dialogue" class="'+f+'"><p>'+b+'</p><a href="#" class="ok">'+Perch.Lang.get("Yes")+'</a><a href="#" class="cancel">'+Perch.Lang.get("No")+'</a><span class="speak"></span></div>'),$(".main").append(e),e.css({top:g.offset().top-(e.outerHeight()+10),left:g.offset().left-e.outerWidth()/2-36}).fadeIn("fast"),e.find("a.ok").click(function(a){a.preventDefault(),c(),z()}),e.find("a.cancel").click(function(a){a.preventDefault(),d(),z()})},z=function(){e&&e.fadeOut("fast",function(){e=!1})},A=function(){setInterval(function(){$.get(Perch.path+"/core/inc/keepalive.php")},f)},B=function(){$("form .checkboxes").length&&$("form .checkboxes").on("change","input[type=checkbox]",function(){var a=$(this);a.is(":checked")&&(a.hasClass("single")?a.parents(".checkboxes").find("input[type=checkbox]:not(.single, :disabled)").attr("checked",!1):a.parents(".checkboxes").find("input[type=checkbox].single").attr("checked",!1))})},C=function(){var a=$("form input[data-urlify]");a.length&&a.parents("form").on("change","input[data-urlify]",function(){var a=$(this),b=$("#"+a.attr("data-urlify"));b.length&&$.get(Perch.path+"/core/async/urlify.php?s="+encodeURIComponent(a.val()),function(a){b.val(a)})});var a=$("form input[data-copy]");a.length&&a.parents("form").on("change","input[data-copy]",function(){var a=$(this),b=$("#"+a.attr("data-copy"));if(b.length){var c=a.val();b.val(c)}})},D=function(){var a=$("#dashboard");a.length&&a.sortable({handle:"h2",cursor:"move",stop:function(){var b=[];a.find(".widget[data-app]").each(function(a,c){b.push($(c).attr("data-app"))}),$.post(window.location,{_perch_ajax:1,formaction:"reorder",token:Perch.token,order:b.join(",")},function(a){Perch.token=a})}})},E=function(){var a=$(".sidebar .searchbox");a.length&&$(".metanav").on("click","a.search",function(a){a.preventDefault(),u(function(){$(".sidebar .searchbox").addClass("focus").find("input").focus()})})};return{init:g,resizeFields:p,initSmartBar:s}}(),Perch.Apps.Content=function(){var a=function(){c(),b()},b=function(){var a=$("ul.reorder");if(a.length){var b=1e3,c=a.attr("data-start");c&&(b=parseInt(c)),a.sortable({stop:function(){a.find("input").each(function(a,c){$(c).val(a+b)})}})}},c=function(){var a=$("#content-list");if(a.length){var b=$(window);a.on("click","a.toggle",function(a){var c=$(a.target);c.attr("href",c.attr("href")+"#sc"+b.scrollTop())});var c=window.location.hash;if(c.length){var d=c.replace("#sc","");b.scrollTop(d)}}};return{init:a}}(),Perch.Lang=function(){var a={},b=function(b){a=b},c=function(b){return a[b]?a[b]:b};return{init:b,get:c}}(),Perch.Privs=function(){var a=[],b=function(b){a=b},c=function(b){return a.indexOf(b)};return{init:b,has:c}}(),"undefined"!=typeof jQuery?(jQuery.fn.selfHealingRemove=function(a,b){return jQuery.isFunction(a)?(b=a,a={}):a=jQuery.extend({speed:"slow"},a),this.each(function(){var c=jQuery(this);c.animate({opacity:0},a.speed,function(){c.slideUp(a.speed,function(){c.remove(),jQuery.isFunction(b)&&b()})})})},jQuery.cookie=function(a,b,c){if(arguments.length>1&&"[object Object]"!==String(b)){if(c=jQuery.extend({},c),(null===b||void 0===b)&&(c.expires=-1),"number"==typeof c.expires){var d=c.expires,e=c.expires=new Date;e.setDate(e.getDate()+d)}return b=String(b),document.cookie=[encodeURIComponent(a),"=",c.raw?b:encodeURIComponent(b),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}c=b||{};var f,g=c.raw?function(a){return a}:decodeURIComponent;return(f=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(document.cookie))?g(f[1]):null},jQuery(function(){Perch.UI.Global.init();for(var a in Perch.Apps)Perch.Apps[a].init()})):window.onload=function(){document.getElementById("appmenu").parentNode.style.display="block"},"undefined"==typeof Perch&&(Perch={},Perch.UI={},Perch.Apps={}),Perch.UI.Assets=function(){var a,b=!1,c=!1,d=!1,e="default",f=1,g=0,h={},i={},j=$(window),k=[],l=function(){$("body").addClass("js"),$.ajaxSetup({cache:!0,data:{v:Perch.version}}),m(),n(),head.ready(["lang","privs"],function(){v(function(){o()})}),C(),E(),$(window).on("Perch_Init_Editors",function(){n()})},m=function(a){if(!a)var a=$(".asset-badge");a.on("change","input[type=checkbox]",function(){var a=$(this),b=a.parents(".asset-badge").find(".asset-badge-thumb");a.is(":checked")?b.addClass("asset-strikethrough"):b.removeClass("asset-strikethrough")})},n=function(){var a=$(".ft-choose-asset:not(.assets-disabled):not([data-init])");a.length&&(head.ready(["lang"],function(){var b=Perch.Lang.get("Select or upload an image");a.is(".ft-file")&&(b=Perch.Lang.get("Select or upload a file")),a.html('<a href="#" class="disabled">'+b+"</a>")}),head.ready(["lang","privs"],function(){a.find("a.disabled").removeClass("disabled")}),$("form").on("click",".ft-choose-asset:not(.assets-disabled) a",function(a){a.preventDefault();var b=$(this);if(!b.is(".disabled")){var f=b.parent(".ft-choose-asset");c=f.attr("data-field"),d=f.attr("data-input"),e=f.attr("data-bucket"),s(f.attr("data-type"))}}),a.parents(".field").find("input[type=file]").hide(),a.parents(".field-wrap").css("vertical-align","top"),a.attr("data-init",!0))},o=function(){var a=Handlebars.templates["asset-chooser"];$(".main").before(a({upload_url:Perch.path+"/core/apps/assets/upload/"})),$(".asset-chooser").hide(),$(".asset-field").on("click",".alert .action",function(a){a.preventDefault(),h={view:h.view},p($("#asset-filter"))}),$.getScript(Perch.path+"/core/assets/js/jquery.slimscroll.min.js",function(){var a=$(window).height(),b=$("body").height();$(".asset-field .inner").slimScroll({height:a-160+"px",railVisible:!0,alwaysVisible:!0}).bind("slimscroll",function(a,b){"bottom"==b&&w(h,y)}),$(".asset-chooser").css("height",b+20)}),$(".asset-field").on("click keypress",".grid-asset, .list-asset-title",function(a){a.preventDefault();var b=$(a.target);b.is(".list-asset-title")||b.is(".grid-asset")||(b=b.parents(".grid-asset")),u(b)}),$(".asset-field").on("dblclick",".grid-asset, .list-asset-title",function(a){a.preventDefault();var e=$(a.target);if(!e.is(".list-asset-title")&&!e.is(".grid-asset")){e=e.parents(".grid-asset"),u(e);var f=k[b];B(f),t(),j.trigger("Perch.asset_deselected"),b=!1,c=!1,d=!1}}),j.on("Perch.asset_selected",function(){$(".asset-topbar .actions .select").addClass("active")}),j.on("Perch.asset_deselected",function(){$(".asset-topbar .actions .select").removeClass("active")}),$(".asset-topbar").on("click",".select.active",function(a){a.preventDefault();var e=k[b];B(e),t(),j.trigger("Perch.asset_deselected"),b=!1,c=!1,d=!1}),$(".asset-topbar").on("click",".add",function(a){a.preventDefault(),j.trigger("Perch.asset_deselected"),$(".asset-drop").is(".open")?r():q()}),$(".asset-topbar .close").on("click",function(a){a.preventDefault(),j.trigger("Perch.asset_deselected"),t()}),$.getScript(Perch.path+"/core/assets/js/dropzone.js"),$.getScript(Perch.path+"/core/assets/js/spin.min.js"),$.ajax({url:Perch.path+"/core/apps/assets/async/asset-filter.php",cache:!1,success:function(a){var b=$("#asset-filter");b.append(a),b.on("click","a:not(.action)",function(a){var c=$(a.target),d=c.parent("li"),e=d.parent("ul");e.is(".open")&&d!=e.find("li").first()?a.preventDefault():(a.preventDefault(),p(b,c.attr("href")))}),b.on("submit","form",function(a){a.preventDefault();var c=$(a.target).find("input.search");p(b,"?q="+c.val())})}})},p=function(a,b){b||(b=""),b&&b.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(a,b,c,d){h[b]=d}),$.ajax({url:Perch.path+"/core/apps/assets/async/asset-filter.php",data:h,success:function(b){a.html(b),Perch.UI.Global.initSmartBar(a)}}),x()},q=function(a){var b=$(".asset-drop"),c=b.find("form");b.animate({height:"220px"}).addClass("open"),$(".asset-field").animate({top:"60px"});var d=0;if(!b.is(".dropzone")){var f=!1;b.addClass("dropzone"),c.addClass("dropzone"),c.dropzone({clickable:!0,dictDefaultMessage:Perch.Lang.get("Drop files here or click to upload")+"<small>"+Perch.Lang.get("Bucket")+": "+e.charAt(0).toUpperCase()+e.slice(1)+"</small>",uploadMultiple:!1,maxFilesize:2048,totaluploadprogress:function(a){d=a},success:function(b,c){100==d&&(r(),a?document.location.reload(!0):(c.type&&(h.type=c.type),f||(f=!0,x())))},reset:function(){f=!1},fallback:function(){$.getScript(Perch.path+"/core/assets/js/jquery.form.min.js",function(){c.ajaxForm({beforeSubmit:function(){z()},success:function(){A(),r(),x()}})})},sending:function(a,b,c){c.append("bucket",e)},complete:function(a){this.removeFile(a)}})}},r=function(){$(".asset-drop").animate({height:"0"}).removeClass("open"),$(".asset-field").animate({top:"60px"})},s=function(a){var b=$("body");b.hasClass("sidebar-open")&&b.removeClass("sidebar-open").addClass("sidebar-closed"),$(".asset-chooser").addClass("transitioning").show().animate({width:"744px"},function(){$(".main").one("click",t),h={type:a,bucket:e},i=jQuery.extend(!0,{},h),0==k.length&&w(h,y),$(".asset-chooser").removeClass("transitioning")}),$(".main, .topbar, .submit.stuck").animate({left:"-800px",right:"800px"}),$(".main").addClass("asset-chooser-open"),Perch.UI.Global.initSmartBar($("#asset-filter")),$(".metanav").on("click",".logout",function(a){a.preventDefault(),t()})},t=function(){$(".asset-chooser").addClass("transitioning").animate({width:"0"},function(){$(this).hide()}),$(".main").animate({left:"0"}),$(".topbar, .submit.stuck").animate({left:"0",right:"55px"},function(){$(".topbar").css("right","")}),$(".main").removeClass("asset-chooser-open").unbind("click",t),$(".metanav").unbind()},u=function(a){b=a.attr("data-id"),a.is(".selected")?($(".asset-field .selected").removeClass("selected"),j.trigger("Perch.asset_deselected"),b=!1):($(".asset-field .selected").removeClass("selected"),a.addClass("selected"),j.trigger("Perch.asset_selected"))},v=function(a){$.getScript(Perch.path+"/core/assets/js/handlebars.runtime.js",function(){$.getScript(Perch.path+"/core/assets/js/templates.js",function(){a()}),Handlebars.registerHelper("Lang",function(a){return Perch.Lang.get(a)}),Handlebars.registerHelper("hasPriv",function(a,b){return Perch.Privs.has(a)>=0?b.fn(this):void 0})})},w=function(a,b){var c=function(a){return function(b){if(g=f,b.assets.length){var c,d;for(c=0,d=b.assets.length;d>c;c++)k[b.assets[c].id]=b.assets[c];f++}a(b)}};f>g&&(z(),$.ajax({dataType:"json",url:Perch.path+"/core/apps/assets/async/get-assets.php?page="+f,data:a,success:c(b),cache:!1}))},x=function(){f=1,g=0,k=[],$(".grid-asset, .list-asset").remove(),w(h,y)},y=function(a){if(h.view&&"list"==h.view)var b=Handlebars.templates["asset-list"];else var b=Handlebars.templates["asset-grid"];var c=$(".asset-field .inner");c.find(".notice").remove(),A(),f>1&&!a.assets.length||c.append(b(a))},z=function(){a||(a=(new Spinner).spin($(".asset-field").get(0)))},A=function(){a&&(a.stop(),a=!1)},B=function(a){var b=$("#"+c);b.val(a.id);var e=a;e.asset_field=c,e.input_id=d;var f=Handlebars.templates["asset-badge"];$(".asset-badge[data-for="+c+"]").replaceWith(f(e)),m($(".asset-badge[data-for="+c+"]"))},C=function(){var a=$("input[data-tags]");a.length&&($("<link/>",{rel:"stylesheet",type:"text/css",href:Perch.path+"/core/assets/css/jquery.tagsinput.css"}).appendTo("head"),$.getScript(Perch.path+"/core/assets/js/jquery.tagsinput.min.js",function(){D(a)}))},D=function(a){a||(a=$("input[data-tags]")),a.each(function(a,b){var c=$(b);c.tagsInput({autocomplete_url:Perch.path+c.attr("data-tags"),width:"340px",defaultText:Perch.Lang.get("Add a tag"),interactive:!0})})},E=function(){var a=$("#staticdrop");a.length&&(head.ready(["lang","privs"],function(){v(function(){var a=Handlebars.templates["asset-static-drop"];$("h1").after(a({upload_url:Perch.path+"/core/apps/assets/upload/"})),$.getScript(Perch.path+"/core/assets/js/dropzone.js"),$.getScript(Perch.path+"/core/assets/js/spin.min.js")})}),a.on("click",function(a){a.preventDefault(),$(".asset-drop").is(".open")?r():q(!0)}))},F=function(a){return e=a,"Bucket set to "+a};return{init:l,setTargetBucket:F,reinit:n}}(),"undefined"!=typeof jQuery&&jQuery(function(){Perch.UI.Assets.init()}),"undefined"==typeof Perch&&(Perch={},Perch.UI={},Perch.Apps={}),Perch.UI.Repeaters=function(){var a,b=function(){$("body").addClass("js"),document.all&&document.querySelector&&!document.addEventListener&&(a=!0),$(".repeater").length&&(c(),d()),$(window).on("Perch_Init_Editors",function(){c()})},c=function(){$(".repeater:not([data-init])").length&&(g(),head.ready(["lang"],function(){h(),f(),e(),d(),$(".repeater:not([data-init])").attr("data-init",!0)}))},d=function(){$(".repeater:first").parents("form").on("submit",function(){$(".repeater").each(function(a,b){var c=$(b),d=c.find(".repeater-footer input.count");d.val(c.find(".repeated-item:not(.spare)").length),c.find(".spare").remove()})})},e=function(){$(".repeater:not([data-init]) .repeated .rm").each(function(a,b){var c=$(b),d=$('<a href="#" class="icon"><span>'+Perch.Lang.get("Delete this item?")+"</span></a>");d.appendTo(c)}),$(".repeater:not([data-init])").on("click",".rm a",function(a){a.preventDefault();var b=$(this),c=b.parents(".repeater");b.parents(".repeated-item").selfHealingRemove({speed:"fast"},function(){k(c)})})},f=function(){$(".repeater:not([data-init]) .repeated").sortable({items:"> .repeated-item",handle:".index",axis:"y",helper:function(a,b){var c=b.children(),d=b.clone();return d.children().each(function(a){$(this).width(c.eq(a).width())}),d},update:function(){k($(this).parents(".repeater"))},sort:function(){$(this).parents(".repeater").find(".ui-sortable-helper").siblings(".repeated-item").addClass("sorting")},stop:function(){$(this).parents(".repeater").find(".repeated-item").removeClass("sorting")}})},g=function(){var a=$(".repeater .repeated-item.spare");a.hide(),a.find("*[required]").attr("required",!1).attr("data-required","true")},h=function(){var a=$(".repeater:not([data-init])");a.find(".repeater-footer").append($('<a href="#" class="icon plusone add">'+Perch.Lang.get("Add Another")+"</a>")),i(),a.on("click","a.plusone",function(a){a.preventDefault();var b=$(a.target);if(b.hasClass("disabled"))return!1;var c=b.closest(".repeater");if(c){var d=c.find(".spare");d.length&&(d.find("*[data-required]").attr("data-required",!1).attr("required",!0),d.removeClass("spare").fadeIn(function(){var a=c.find(".repeated-item"),b=j(d,a.length,c.attr("data-prefix")),e=c.find(".repeated");e.append(b),e.animate({scrollTop:e.prop("scrollHeight")-e.height()},1e3),b.addClass("spare"),g(),k(c),i()}))}$(window).trigger("Perch.FieldTypes.redraw")})},i=function(){$(".repeater[data-max]").each(function(a,b){var c=$(b),d=c.find(".repeated-item:not(.spare)"),e=parseInt(c.attr("data-max"));d.length>=e?c.find("a.plusone").addClass("disabled"):c.find("a.plusone").removeClass("disabled")})},j=function(a,b,c){var d=a.clone(),e=b-1,f=c+"_"+e+"_";d.find('*[id*="'+f+'"]').each(function(a,d){var e=$(d);e.attr("id",e.attr("id").replace(f,c+"_"+b+"_"))}),d.find('*[name*="'+f+'"]').each(function(a,d){var e=$(d);e.attr("name",e.attr("name").replace(f,c+"_"+b+"_"))}),d.find('label[for*="'+f+'"]').each(function(a,d){var e=$(d);e.attr("for",e.attr("for").replace(f,c+"_"+b+"_"))});for(var g=d.get(0).getElementsByTagName("*"),h=0;h<g.length;h++)for(var i=g[h],j=i.attributes,k=0;k<j.length;k++)-1!=j[k].value.indexOf(f)&&(j[k].value=j[k].value.replace(f,c+"_"+b+"_"));return d.find(".index span:not(.icon)").text(b+1),d},k=function(a){var b=a.find(".repeated-item, .repeater-footer"),c=a.attr("data-prefix");b.each(function(a,b){var d=$(b),e=a,f=c+"_",g=new RegExp(f+"([0-9]+)_","i");d.find('*[id^="'+f+'"]').each(function(a,b){var d=$(b);d.attr("id",d.attr("id").replace(g,c+"_"+e+"_"))}),d.find('*[name^="'+f+'"]').each(function(a,b){var d=$(b);d.attr("name",d.attr("name").replace(g,c+"_"+e+"_"))}),d.find('label[for^="'+f+'"]').each(function(a,b){var d=$(b);d.attr("for",d.attr("for").replace(g,c+"_"+e+"_"))}),d.find(".index span:not(.icon)").text(e+1)}),i()};return{init:b,reinit:c}}(),Perch.UI.Blocks=function(){var a,b=function(){$("body").addClass("js"),document.all&&document.querySelector&&!document.addEventListener&&(a=!0),$(".blocks").length&&(c(),head.ready(["lang"],function(){f(),$(".block-wrap").attr("data-init",!0)}),e(),d(),g(),$(window).on("Perch_Init_Editors",function(){c(),f(),$(".block-wrap").attr("data-init",!0)}))},c=function(){$(".blocks").each(function(a,b){var c=$(b),d=c.find(".master.block-add-bar");c.find(".block-wrap:not([data-init])").each(function(a,b){var c=$(b),e=d.clone();e.removeClass("master").removeClass("hidden");var f=c.attr("data-block");e.find("a").each(function(a,b){var c=$(b),d=c.attr("href");c.attr("href",d+"&after="+f)}),e.appendTo(c)});var e=c.find(".block-wrap").length;e>0&&d.addClass("hidden"),c.attr("data-next-index",e)})},d=function(){$(".blocks").on("click",".block-add-bar a",function(a){a.preventDefault();var b=$(a.target),c=b.parents(".block-wrap"),d=c.parent(".blocks").attr("data-next-index"),e=b.attr("href");e+="&count="+d;var f=e.split("?");$.ajax(f[0],{type:"POST",data:f[1],success:function(a){c.parent(".blocks").attr("data-next-index",parseInt(d)+1),c.length?c.after(a):b.parents(".blocks").append(a);var e=$(a);$("input[name='_blocks_deleted[]']").each(function(a,b){var c=$(b);c.val()==e.attr("data-prefix")&&c.remove()}),$(window).trigger("Perch_Init_Editors").trigger("Perch_Init_Editors_Post")}})})},e=function(){$("form").on("submit",function(){$(this).find(".block-wrap").each(function(a,b){var c=$(b),d=c.find("input.index");d.val(a)})})},f=function(){$(".block-wrap:not([data-init]) .divider .rm").each(function(a,b){var c=$(b),d=$('<a href="#" class="icon"><span>'+Perch.Lang.get("Delete this item?")+"</span></a>");d.appendTo(c)}),$(".block-wrap:not([data-init])").on("click",".divider .rm a",function(a){a.preventDefault();var b=$(this),c=b.parents(".block-wrap");c.after($('<input type="hidden" name="_blocks_deleted[]" value="'+c.attr("data-prefix")+'" />'));var d=b.parents(".blocks");1==d.find(".block-wrap").length&&d.find(".master.block-add-bar").hide().removeClass("hidden").fadeIn("fast"),c.selfHealingRemove({speed:"fast"})})},g=function(){$(".blocks").sortable({items:"> .block-wrap",handle:".divider",axis:"y"})};return{init:b,reinit:c}}(),"undefined"!=typeof jQuery&&jQuery(function(){Perch.UI.Repeaters.init(),Perch.UI.Blocks.init()});