"undefined"==typeof Perch&&(Perch={},Perch.UI={},Perch.Apps={}),Perch.UI.Global=function(){var e,n,t="cmssb",a=!1,o=!1,i=3e5,r=function(){$("body").addClass("js"),document.all&&document.querySelector&&!document.addEventListener&&(e=!0),document.all&&!document.querySelector&&(n=!0),head.load({lang:Perch.path+"/core/inc/js_lang.php?v="+Perch.version},{privs:Perch.path+"/core/inc/js_privs.php?v="+Perch.version}),$.ajaxSetup({cache:!0,data:{v:Perch.version}}),k(),w(),m(),b($(".main")),c(),s(),d(),I(),_(),e||C(),e||P(),L(),D(),U()},c=function(){$("a.assist, a.draft-preview").click(function(e){e.preventDefault(),window.open($(this).attr("href"))})},s=function(){$("p.alert.success")&&setTimeout(function(){$("p.alert.success").selfHealingRemove()},5e3)},d=function(){$(window).on("load",function(){h(),v()}),$(window).on("resize",function(){a=!0,setTimeout(function(){a&&(h(),a=!1)},1e3),v()}),g(),l(),u(),f(),$(window).on("Perch_Init_Editors_Post",function(){v(),f()})},l=function(){if(!e){var n=$("form.magnetic-save-bar");n.length&&document.addEventListener("keydown",function(e){83==e.keyCode&&(navigator.platform.match("Mac")?e.metaKey:e.ctrlKey)&&(e.preventDefault(),n.submit())},!1)}},u=function(){var e=$(".routes-spare"),n=$(".field.routes");e.length&&n.length&&(e.addClass("hidden"),e.parent().find(".routes:last").append('<a href="#" class="icon plusone add">'+Perch.Lang.get("Add another")+"</a>"),$(".routes").on("click",".plusone",function(n){n.preventDefault(),e.removeClass("hidden").find("input").focus(),$(this).selfHealingRemove()}))},f=function(){var e=$("[data-count]");e.on("keyup",function(){p(this)}),e.each(function(e,n){p(n)})},p=function(e){var n=$(e),t=$("#"+n.attr("data-count-container")),a=n.val();a&&("words"==n.attr("data-count")?t.html(a.match(/\S+/g).length):t.html(a.length))},h=function(){if(!e){var n=$(".magnetic-save-bar p.submit");if(n.length&&!n.hasClass("nonstick")){var t=$(window),a=n.position().top,o=n.outerHeight(!0),i=t.height(),r=$("p.alert");r&&(a-=r.outerHeight(!0)),$("body").height()>i&&(t.scroll(function(){var e=t.scrollTop()+i-o-70,r=.7;if(a>e){n.addClass("stuck"),n.parents("form").addClass("with-stuck");var c=e-a;r=-c<50?.7/100*(-c/50*100):.7,n.hasClass("error")?n.css("background-color","rgba(179, 64, 64, "+r+")"):n.css("background-color","rgba(191, 191, 191, "+r+")")}else n.removeClass("stuck"),n.parents("form").removeClass("with-stuck"),n.css("background-color","rgba(255, 255, 255, 1)")}),t.scroll())}}},v=function(){var e=$("textarea.autowidth, .editor-wrap");e.length&&e.each(function(e,n){var t=$(n),a=t.parents("div.field"),o=a.find("label:first");if(a&&o){var i=a.innerWidth()-o.outerWidth();i>200&&t.width(i-41)}})},g=function(){$(".divider").prev("div.field").addClass("predivider")},m=function(){$("body");$.getScript(Perch.path+"/core/assets/js/headroom.min.js",function(){var e=new Headroom($(".topbar").get(0),{offset:60,tolerance:0});e.init()})},b=function(e){var n;if(n=e?e.find(".smartbar:not(.ready)"):$(".smartbar:not(.ready)"),n.length){var t=n.find(".filter");t.on("click","li a",function(e){var n=$(this).parent("li"),t=n.parents("ul");t.hasClass("open")&&!n.is(":first-child")||e.preventDefault(),t.hasClass("open")?(t.removeClass("open"),t.parent("li").find(".proxy").remove()):(t.parent("li").append($('<p class="proxy">.</p>')),t.addClass("open"))}),t.each(function(e,n){var t=$(n);t.css("width",t.find("li:first-child").outerWidth())}),n.addClass("ready")}},k=function(){var e=$("body");1==$.cookie(t)&&e.addClass("sidebar-closed").removeClass("sidebar-open"),head.ready(["lang"],function(){$(".topbar").append($('<a href="#" id="sidebar-toggle" class="icon"><span>'+Perch.Lang.get("Toggle sidebar")+"</span></a>"));var e=$("#sidebar-toggle");e.on("click",function(e){e.preventDefault(),y()})})},y=function(e){var n=$("body");n.toggleClass("sidebar-closed").toggleClass("sidebar-open"),n.hasClass("sidebar-closed")?$.cookie(t,1,{path:"/"}):$.cookie(t,0,{path:"/"}),v(),$(window).trigger("perch.sidebar-toggle"),e&&e()},w=function(){var e=$("#appmenu ul.appmenu"),t=e.find("li");if(t.length>1&&!n){e.addClass("menu");var a=$("#appmenu");a.addClass("menucont");var o,i=e.find("li.selected a:not(.add)").text();i?o=!0:(i=Perch.Lang.get("Apps"),o=!1);var r=$('<a class="trigger" href="#">'+i+"</a>");e.before(r).hide(),o&&r.parent("li").addClass("selected"),e.prepend($('<li class="dumb"><a class="trigger" href="#">'+i+'</a></li><li class="spaceinvader"></li>')),a.hover(function(){e.show()},function(){e.hide()}),r.click(function(n){n.preventDefault(),e.show()}),e.find("a.trigger").click(function(n){n.preventDefault(),e.hide()})}$(".topbar .mainnav").show()},C=function(){$("a.inline-delete").click(function(e){e.preventDefault();var n=$(this),t=Perch.Lang.get("Delete this item?");n.attr("data-msg")&&(t=n.attr("data-msg")),x(e,t,function(){$.post(n.attr("href"),{_perch_ajax:1,formaction:"delete",token:Perch.token},function(e){window.location=e})},function(){j()},"delete")})},P=function(){$("a.inline-confirm").click(function(e){e.preventDefault();var n=$(this),t=Perch.Lang.get("Are you sure?");n.attr("data-msg")&&(t=n.attr("data-msg")),x(e,t,function(){$.post(n.attr("href"),{_perch_ajax:1,formaction:"confirm",token:Perch.token},function(e){window.location=e})},function(){j()},"confirm")})},x=function(e,n,t,a,i){o&&j();var r=$(e.target);o=$('<div id="confirm-dialogue" class="'+i+'"><p>'+n+'</p><a href="#" class="ok">'+Perch.Lang.get("Yes")+'</a><a href="#" class="cancel">'+Perch.Lang.get("No")+'</a><span class="speak"></span></div>'),$(".main").append(o),o.css({top:r.offset().top-(o.outerHeight()+10),left:r.offset().left-o.outerWidth()/2-36}).fadeIn("fast"),o.find("a.ok").click(function(e){e.preventDefault(),t(),j()}),o.find("a.cancel").click(function(e){e.preventDefault(),a(),j()})},j=function(){o&&o.fadeOut("fast",function(){o=!1})},D=function(){setInterval(function(){$.get(Perch.path+"/core/inc/keepalive.php")},i)},I=function(){$("form .checkboxes").length&&$("form .checkboxes").on("change","input[type=checkbox]",function(){var e=$(this);e.is(":checked")&&(e.hasClass("single")?e.parents(".checkboxes").find("input[type=checkbox]:not(.single, :disabled)").attr("checked",!1):e.parents(".checkboxes").find("input[type=checkbox].single").attr("checked",!1))})},_=function(){var e=$("form input[data-urlify]");e.length&&e.parents("form").on("change","input[data-urlify]",function(){var e=$(this),n=$("#"+e.attr("data-urlify"));n.length&&$.get(Perch.path+"/core/async/urlify.php?s="+encodeURIComponent(e.val()),function(e){n.val(e)})}),e=$("form input[data-copy]"),e.length&&e.parents("form").on("change","input[data-copy]",function(){var e=$(this),n=$("#"+e.attr("data-copy"));if(n.length){var t=e.val();n.val(t)}})},L=function(){var e=$("#dashboard");e.length&&e.sortable({handle:"h2",cursor:"move",stop:function(){var n=[];e.find(".widget[data-app]").each(function(e,t){n.push($(t).attr("data-app"))}),$.post(window.location,{_perch_ajax:1,formaction:"reorder",token:Perch.token,order:n.join(",")},function(e){Perch.token=e})}})},U=function(){var e=$(".sidebar .searchbox");e.length&&$(".metanav").on("click","a.search",function(e){e.preventDefault(),y(function(){$(".sidebar .searchbox").addClass("focus").find("input").focus()})})};return{init:r,resizeFields:v,initSmartBar:b}}(),Perch.Apps.Content=function(){var e=function(){t(),n()},n=function(){var e=$("ul.reorder");if(e.length){var n=1e3,t=e.attr("data-start");t&&(n=parseInt(t)),e.sortable({stop:function(){e.find("input").each(function(e,t){$(t).val(e+n)})}})}},t=function(){var e=$("#content-list");if(e.length){var n=$(window);e.on("click","a.toggle",function(e){var t=$(e.target);t.attr("href",t.attr("href")+"#sc"+n.scrollTop())});var t=window.location.hash;if(t.length){var a=t.replace("#sc","");n.scrollTop(a)}}};return{init:e}}(),Perch.Lang=function(){var e={},n=function(n){e=n},t=function(n){return e[n]?e[n]:n};return{init:n,get:t}}(),Perch.Privs=function(){var e=[],n=function(n){e=n},t=function(n){return e.indexOf(n)};return{init:n,has:t}}(),"undefined"!=typeof jQuery?(jQuery.fn.selfHealingRemove=function(e,n){return jQuery.isFunction(e)?(n=e,e={}):e=jQuery.extend({speed:"slow"},e),this.each(function(){var t=jQuery(this);t.animate({opacity:0},e.speed,function(){t.slideUp(e.speed,function(){t.remove(),jQuery.isFunction(n)&&n()})})})},jQuery.cookie=function(e,n,t){if(arguments.length>1&&"[object Object]"!==String(n)){if(t=jQuery.extend({},t),null!==n&&void 0!==n||(t.expires=-1),"number"==typeof t.expires){var a=t.expires,o=t.expires=new Date;o.setDate(o.getDate()+a)}return n=String(n),document.cookie=[encodeURIComponent(e),"=",t.raw?n:encodeURIComponent(n),t.expires?"; expires="+t.expires.toUTCString():"",t.path?"; path="+t.path:"",t.domain?"; domain="+t.domain:"",t.secure?"; secure":""].join("")}t=n||{};var i,r=t.raw?function(e){return e}:decodeURIComponent;return(i=new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)").exec(document.cookie))?r(i[1]):null},jQuery(function(e){Perch.UI.Global.init();for(var n in Perch.Apps)Perch.Apps[n].init()})):window.onload=function(){document.getElementById("appmenu").parentNode.style.display="block"};
"undefined"==typeof Perch&&(Perch={},Perch.UI={},Perch.Apps={}),Perch.UI.Assets=function(){var e,t=!1,s=!1,a=!1,n="default",i=1,r=0,c={},o={},l=$(window),d=[],p=function(){$("body").addClass("js"),$.ajaxSetup({cache:!0,data:{v:Perch.version}}),u(),f(),head.ready(["lang","privs"],function(){y(function(){h()})}),D(),z(),$(window).on("Perch_Init_Editors",function(){f()})},u=function(e){e||(e=$(".asset-badge")),e.on("change","input[type=checkbox]",function(e){var t=$(this),s=t.parents(".asset-badge").find(".asset-badge-thumb");t.is(":checked")?s.addClass("asset-strikethrough"):s.removeClass("asset-strikethrough")})},f=function(){var e=$(".ft-choose-asset:not(.assets-disabled):not([data-init])");e.length&&(head.ready(["lang"],function(){var t=Perch.Lang.get("Select or upload an image");e.is(".ft-file")&&(t=Perch.Lang.get("Select or upload a file")),e.html('<a href="#" class="disabled">'+t+"</a>")}),head.ready(["lang","privs"],function(){e.find("a.disabled").removeClass("disabled")}),$("form").on("click",".ft-choose-asset:not(.assets-disabled) a",function(e){e.preventDefault();var t=$(this);if(!t.is(".disabled")){var i=t.parent(".ft-choose-asset");s=i.attr("data-field"),a=i.attr("data-input"),n=i.attr("data-bucket"),b(i.attr("data-type"))}}),e.parents(".field").find("input[type=file]").hide(),e.parents(".field-wrap").css("vertical-align","top"),e.attr("data-init",!0))},h=function(){var e=Handlebars.templates["asset-chooser"];$(".main").before(e({upload_url:Perch.path+"/core/apps/assets/upload/"})),$(".asset-chooser").hide(),$(".asset-field").on("click",".alert .action",function(e){e.preventDefault(),c={view:c.view},g($("#asset-filter"))}),$.getScript(Perch.path+"/core/assets/js/jquery.slimscroll.min.js",function(){var e=$(window).height(),t=$("body").height();$(".asset-field .inner").slimScroll({height:e-160+"px",railVisible:!0,alwaysVisible:!0}).bind("slimscroll",function(e,t){"bottom"==t&&k(c,x)}),$(".asset-chooser").css("height",t+20)}),$(".asset-field").on("click keypress",".grid-asset, .list-asset-title",function(e){e.preventDefault();var t=$(e.target);t.is(".list-asset-title")||t.is(".grid-asset")||(t=t.parents(".grid-asset")),j(t)}),$(".asset-field").on("dblclick",".grid-asset, .list-asset-title",function(e){e.preventDefault();var n=$(e.target);if(!n.is(".list-asset-title")&&!n.is(".grid-asset")){n=n.parents(".grid-asset"),j(n);var i=d[t];_(i),P(),l.trigger("Perch.asset_deselected"),t=!1,s=!1,a=!1}}),l.on("Perch.asset_selected",function(){$(".asset-topbar .actions .select").addClass("active")}),l.on("Perch.asset_deselected",function(){$(".asset-topbar .actions .select").removeClass("active")}),$(".asset-topbar").on("click",".select.active",function(e){e.preventDefault();var n=d[t];_(n),P(),l.trigger("Perch.asset_deselected"),t=!1,s=!1,a=!1}),$(".asset-topbar").on("click",".add",function(e){e.preventDefault(),l.trigger("Perch.asset_deselected"),$(".asset-drop").is(".open")?m():v()}),$(".asset-topbar .close").on("click",function(e){e.preventDefault(),l.trigger("Perch.asset_deselected"),P()}),$.getScript(Perch.path+"/core/assets/js/dropzone.js"),$.getScript(Perch.path+"/core/assets/js/spin.min.js"),$.ajax({url:Perch.path+"/core/apps/assets/async/asset-filter.php",cache:!1,success:function(e){var t=$("#asset-filter");t.append(e),t.on("click","a:not(.action)",function(e){var s=$(e.target),a=s.parent("li"),n=a.parent("ul");n.is(".open")&&a!=n.find("li").first()?e.preventDefault():(e.preventDefault(),g(t,s.attr("href")))}),t.on("submit","form",function(e){e.preventDefault();var s=$(e.target).find("input.search");g(t,"?q="+s.val())})}})},g=function(e,t){t||(t=""),t&&t.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,t,s,a){c[t]=a}),$.ajax({url:Perch.path+"/core/apps/assets/async/asset-filter.php",data:c,success:function(t){e.html(t),Perch.UI.Global.initSmartBar(e)}}),C()},v=function(e){var t=$(".asset-drop"),s=t.find("form");t.animate({height:"220px"}).addClass("open"),$(".asset-field").animate({top:"60px"});var a=0;if(!t.is(".dropzone")){var i=!1;t.addClass("dropzone"),s.addClass("dropzone"),s.dropzone({clickable:!0,dictDefaultMessage:Perch.Lang.get("Drop files here or click to upload")+"<small>"+Perch.Lang.get("Bucket")+": "+n.charAt(0).toUpperCase()+n.slice(1)+"</small>",uploadMultiple:!1,maxFilesize:2048,totaluploadprogress:function(e){a=e},success:function(t,s){100==a&&(m(),e?document.location.reload(!0):(s.type&&(c.type=s.type),i||(i=!0,C())))},reset:function(){i=!1},fallback:function(){$.getScript(Perch.path+"/core/assets/js/jquery.form.min.js",function(){s.ajaxForm({beforeSubmit:function(){w()},success:function(e){S(),m(),C()}})})},sending:function(e,t,s){s.append("bucket",n)},complete:function(e){this.removeFile(e)}})}},m=function(){$(".asset-drop").animate({height:"0"}).removeClass("open"),$(".asset-field").animate({top:"60px"})},b=function(e){var t=$("body");t.hasClass("sidebar-open")&&t.removeClass("sidebar-open").addClass("sidebar-closed"),$(".asset-chooser").addClass("transitioning").show().animate({width:"744px"},function(){$(".main").one("click",P),c={type:e,bucket:n},o=jQuery.extend(!0,{},c),0===d.length&&k(c,x),$(".asset-chooser").removeClass("transitioning")}),$(".main, .topbar, .submit.stuck").animate({left:"-800px",right:"800px"}),$(".main").addClass("asset-chooser-open"),Perch.UI.Global.initSmartBar($("#asset-filter")),$(".metanav").on("click",".logout",function(e){e.preventDefault(),P()})},P=function(){$(".asset-chooser").addClass("transitioning").animate({width:"0"},function(){$(this).hide()}),$(".main").animate({left:"0"}),$(".topbar, .submit.stuck").animate({left:"0",right:"55px"},function(){$(".topbar").css("right","")}),$(".main").removeClass("asset-chooser-open").unbind("click",P),$(".metanav").unbind()},j=function(e){t=e.attr("data-id"),e.is(".selected")?($(".asset-field .selected").removeClass("selected"),l.trigger("Perch.asset_deselected"),t=!1):($(".asset-field .selected").removeClass("selected"),e.addClass("selected"),l.trigger("Perch.asset_selected"))},y=function(e){$.getScript(Perch.path+"/core/assets/js/handlebars.runtime.js",function(){$.getScript(Perch.path+"/core/assets/js/templates.js",function(){e()}).fail(function(e,t,s){}),Handlebars.registerHelper("Lang",function(e){return Perch.Lang.get(e)}),Handlebars.registerHelper("hasPriv",function(e,t){if(Perch.Privs.has(e)>=0)return t.fn(this)})})},k=function(e,t){var s=function(e){return function(t){if(r=i,t.assets.length){var s,a;for(s=0,a=t.assets.length;s<a;s++)d[t.assets[s].id]=t.assets[s];i++}e(t)}};i>r&&(w(),$.ajax({dataType:"json",url:Perch.path+"/core/apps/assets/async/get-assets.php?page="+i,data:e,success:s(t),cache:!1}))},C=function(){i=1,r=0,d=[],$(".grid-asset, .list-asset").remove(),k(c,x)},x=function(e){var t;t=c.view&&"list"==c.view?Handlebars.templates["asset-list"]:Handlebars.templates["asset-grid"];var s=$(".asset-field .inner");s.find(".notice").remove(),S(),i>1&&!e.assets.length||s.append(t(e))},w=function(){e||(e=(new Spinner).spin($(".asset-field").get(0)))},S=function(){e&&(e.stop(),e=!1)},_=function(e){var t=$("#"+s);t.val(e.id);var n=e;n.asset_field=s,n.input_id=a;var i=Handlebars.templates["asset-badge"];$(".asset-badge[data-for="+s+"]").replaceWith(i(n)),u($(".asset-badge[data-for="+s+"]"))},D=function(){var e=$("input[data-tags]");e.length&&($("<link/>",{rel:"stylesheet",type:"text/css",href:Perch.path+"/core/assets/css/jquery.tagsinput.css"}).appendTo("head"),$.getScript(Perch.path+"/core/assets/js/jquery.tagsinput.min.js",function(){H(e)}))},H=function(e){e||(e=$("input[data-tags]")),e.each(function(e,t){var s=$(t);s.tagsInput({autocomplete_url:Perch.path+s.attr("data-tags"),width:"340px",defaultText:Perch.Lang.get("Add a tag"),interactive:!0})})},z=function(){var e=$("#staticdrop");e.length&&(head.ready(["lang","privs"],function(){y(function(){var e=Handlebars.templates["asset-static-drop"];$("h1").after(e({upload_url:Perch.path+"/core/apps/assets/upload/"})),$.getScript(Perch.path+"/core/assets/js/dropzone.js"),$.getScript(Perch.path+"/core/assets/js/spin.min.js")})}),e.on("click",function(e){e.preventDefault(),$(".asset-drop").is(".open")?m():v(!0)}))},I=function(e){return n=e,"Bucket set to "+e};return{init:p,setTargetBucket:I,reinit:f}}(),"undefined"!=typeof jQuery&&jQuery(function(e){Perch.UI.Assets.init()});
"undefined"==typeof Perch&&(Perch={},Perch.UI={},Perch.Apps={}),Perch.UI.Repeaters=function(){var e,t=function(){$("body").addClass("js"),document.all&&document.querySelector&&!document.addEventListener&&(e=!0),$(".repeater").length&&(a(),n()),$(window).on("Perch_Init_Editors",function(){a()})},a=function(){$(".repeater:not([data-init])").length&&(d(),head.ready(["lang"],function(){o(),i(),r(),n(),$(".repeater:not([data-init])").attr("data-init",!0)}))},n=function(){$(".repeater:first").parents("form").on("submit",function(){$(".repeater").each(function(e,t){var a=$(t),n=a.find(".repeater-footer input.count");n.val(a.find(".repeated-item:not(.spare)").length),a.find(".spare").remove()})})},r=function(){$(".repeater:not([data-init]) .repeated .rm").each(function(e,t){var a=$(t),n=$('<a href="#" class="icon"><span>'+Perch.Lang.get("Delete this item?")+"</span></a>");n.appendTo(a)}),$(".repeater:not([data-init])").on("click",".rm a",function(e){e.preventDefault();var t=$(this),a=t.parents(".repeater");t.parents(".repeated-item").selfHealingRemove({speed:"fast"},function(){f(a)})})},i=function(){$(".repeater:not([data-init]) .repeated").sortable({items:"> .repeated-item",handle:".index",axis:"y",helper:function(e,t){var a=t.children(),n=t.clone();return n.children().each(function(e){$(this).width(a.eq(e).width())}),n},update:function(e,t){f($(this).parents(".repeater"))},sort:function(e,t){$(this).parents(".repeater").find(".ui-sortable-helper").siblings(".repeated-item").addClass("sorting")},stop:function(e,t){$(this).parents(".repeater").find(".repeated-item").removeClass("sorting")}})},d=function(){var e=$(".repeater .repeated-item.spare");e.hide(),e.find("*[required]").attr("required",!1).attr("data-required","true")},o=function(){var e=$(".repeater:not([data-init])");e.find(".repeater-footer").append($('<a href="#" class="icon plusone add">'+Perch.Lang.get("Add Another")+"</a>")),c(),p(),e.on("click","a.plusone",function(e){e.preventDefault();var t=$(e.target);if(t.hasClass("disabled"))return!1;var a=t.closest(".repeater");if(a){var n=a.find(".spare");n.length&&(n.find("*[data-required]").attr("data-required",!1).attr("required",!0),n.removeClass("spare").fadeIn(function(){var e=a.find(".repeated-item"),t=s(n,e.length,a.attr("data-prefix")),r=a.find(".repeated");r.append(t),r.animate({scrollTop:r.prop("scrollHeight")-r.height()},1e3),t.addClass("spare"),d(),f(a),c()}),p())}$(window).trigger("Perch.FieldTypes.redraw")})},c=function(){$(".repeater[data-max]").each(function(e,t){var a=$(t),n=a.find(".repeated-item:not(.spare)"),r=parseInt(a.attr("data-max"));n.length>=r?a.find("a.plusone").addClass("disabled"):a.find("a.plusone").removeClass("disabled")})},s=function(e,t,a){var n=e.clone(),r=t-1,i=a+"_"+r+"_";n.find('*[id*="'+i+'"]').each(function(e,n){var r=$(n);r.attr("id",r.attr("id").replace(i,a+"_"+t+"_"))}),n.find('*[name*="'+i+'"]').each(function(e,n){var r=$(n);r.attr("name",r.attr("name").replace(i,a+"_"+t+"_"))}),n.find('label[for*="'+i+'"]').each(function(e,n){var r=$(n);r.attr("for",r.attr("for").replace(i,a+"_"+t+"_"))});for(var d=n.get(0).getElementsByTagName("*"),o=0;o<d.length;o++)for(var c=d[o],s=c.attributes,f=0;f<s.length;f++)s[f].value.indexOf(i)!=-1&&(s[f].value=s[f].value.replace(i,a+"_"+t+"_"));return n.find(".index span:not(.icon)").text(t+1),n},f=function(e){var t=e.find(".repeated-item, .repeater-footer"),a=e.attr("data-prefix");t.each(function(e,t){var n=$(t),r=e,i=a+"_",d=new RegExp(i+"([0-9]+)_","i");n.find('*[id^="'+i+'"]').each(function(e,t){var n=$(t);n.attr("id",n.attr("id").replace(d,a+"_"+r+"_"))}),n.find('*[name^="'+i+'"]').each(function(e,t){var n=$(t);n.attr("name",n.attr("name").replace(d,a+"_"+r+"_"))}),n.find('label[for^="'+i+'"]').each(function(e,t){var n=$(t);n.attr("for",n.attr("for").replace(d,a+"_"+r+"_"))}),n.find(".index span:not(.icon)").text(r+1)}),c(),p()},p=function(){var e=$(".repeater");e.each(function(e,t){var a=$(t),n=a.find(".repeated-item:not(.spare)");a.attr("data-item-count",n.length)})};return{init:t,reinit:a}}(),Perch.UI.Blocks=function(){var e,t=function(){$("body").addClass("js"),document.all&&document.querySelector&&!document.addEventListener&&(e=!0),$(".blocks").length&&(a(),head.ready(["lang"],function(){i(),$(".block-wrap").attr("data-init",!0)}),r(),n(),d(),$(window).on("Perch_Init_Editors",function(){a(),i(),$(".block-wrap").attr("data-init",!0)}))},a=function(){$(".blocks").each(function(e,t){var a=$(t),n=a.find(".master.block-add-bar");a.find(".block-wrap:not([data-init])").each(function(e,t){var a=$(t),r=n.clone();r.removeClass("master").removeClass("hidden");var i=a.attr("data-block");r.find("a").each(function(e,t){var a=$(t),n=a.attr("href");a.attr("href",n+"&after="+i)}),r.appendTo(a)});var r=a.find(".block-wrap").length;r>0&&n.addClass("hidden"),a.attr("data-next-index",r)})},n=function(){$(".blocks").on("click",".block-add-bar a",function(e){e.preventDefault();var t=$(e.target),a=t.parents(".block-wrap"),n=a.parent(".blocks").attr("data-next-index"),r=t.attr("href");r+="&count="+n;var i=r.split("?");$.ajax(i[0],{type:"POST",data:i[1],success:function(e){a.parent(".blocks").attr("data-next-index",parseInt(n)+1),a.length?a.after(e):t.parents(".blocks").append(e);var r=$(e);$("input[name='_blocks_deleted[]']").each(function(e,t){var a=$(t);a.val()==r.attr("data-prefix")&&a.remove()}),$(window).trigger("Perch_Init_Editors").trigger("Perch_Init_Editors_Post")}})})},r=function(){$("form").on("submit",function(){$(this).find(".block-wrap").each(function(e,t){var a=$(t),n=a.find("input.index");n.val(e)})})},i=function(){$(".block-wrap:not([data-init]) .divider .rm").each(function(e,t){var a=$(t),n=$('<a href="#" class="icon"><span>'+Perch.Lang.get("Delete this item?")+"</span></a>");n.appendTo(a)}),$(".block-wrap:not([data-init])").on("click",".divider .rm a",function(e){e.preventDefault();var t=$(this),a=t.parents(".block-wrap");a.after($('<input type="hidden" name="_blocks_deleted[]" value="'+a.attr("data-prefix")+'" />'));var n=t.parents(".blocks");1==n.find(".block-wrap").length&&n.find(".master.block-add-bar").hide().removeClass("hidden").fadeIn("fast"),a.selfHealingRemove({speed:"fast"})})},d=function(){$(".blocks").sortable({items:"> .block-wrap",handle:".divider",axis:"y"})};return{init:t,reinit:a}}(),"undefined"!=typeof jQuery&&jQuery(function(e){Perch.UI.Repeaters.init(),Perch.UI.Blocks.init()});